
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>viper.collections &#8212; Viper Infrastructure Commander  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />


  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <h1>Source code for viper.collections</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The Viper Python API</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">The Concept</span>
<span class="sd">^^^^^^^^^^^</span>

<span class="sd">Viper provides a powerful collection of data types such as :py:class:`~viper.Hosts`,</span>
<span class="sd">:py:class:`~viper.Runners`, :py:class:`~viper.Results` etc. and uses *method chaining*</span>
<span class="sd">to perform different operations. The :py:mod:`viper.collection` module contains the</span>
<span class="sd">collection of such data types. These data types share some common properties as</span>
<span class="sd">all the data types inherit from the :py:class:`~viper.collections.Collection` class.</span>

<span class="sd">Example: Method Chaining</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    from viper import Hosts</span>
<span class="sd">    import task</span>

<span class="sd">    print(</span>
<span class="sd">        Hosts.from_file(&quot;hosts.csv&quot;)</span>
<span class="sd">        .task(task.ping())</span>
<span class="sd">        .run(max_workers=50)</span>
<span class="sd">        .final()</span>
<span class="sd">        .order_by(&quot;host.hostname&quot;, &quot;host.ip&quot;)</span>
<span class="sd">        .to_file(&quot;results.csv&quot;)</span>
<span class="sd">        .format(&quot;{host.hostname}: {stdout}&quot;)</span>
<span class="sd">    )</span>

<span class="sd">.. tip:: Refer to :doc:`getting_started` to see how ``task.ping`` and ``hosts.csv`` are written.</span>


<span class="sd">Unit vs Container Types</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="sd">The above mentioned data types can be categorised as unit and container types.</span>
<span class="sd">The unit ones inherit from the :py:class:`~viper.collections.Item` class, while the</span>
<span class="sd">container types inherit from :py:class:`~viper.collections.Items` class.</span>

<span class="sd">Below are the list of unit types and their container type counterparts:</span>

<span class="sd">=========================   ==========================</span>
<span class="sd">Unit Types                  Container Types</span>
<span class="sd">=========================   ==========================</span>
<span class="sd">:py:class:`~viper.Task`</span>
<span class="sd">:py:class:`~viper.Host`     :py:class:`~viper.Hosts`</span>
<span class="sd">:py:class:`~viper.Runner`   :py:class:`~viper.Runners`</span>
<span class="sd">:py:class:`~viper.Result`   :py:class:`~viper.Results`</span>
<span class="sd">=========================   ==========================</span>


<span class="sd">Useful Common Properties &amp; Abilities</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">The properties mentioned below are common to both unit and composite type objects.</span>

<span class="sd">- **Immutable:** All the datatypes are immutable i.e. they cannot be modified</span>
<span class="sd">  once initialized. This is to prevent any unexpected behaviour caused due to</span>
<span class="sd">  stateful-ness.</span>

<span class="sd">- **.from_json() and .to_json():** All the objects can be initialized from JSON</span>
<span class="sd">  texts using the ``.from_json()`` factory method and can be dumped back to JSON</span>
<span class="sd">  using the ``.to_json()`` method. This enables the objects to use a wide range of</span>
<span class="sd">  mediums such as the Unix pipes.</span>

<span class="sd">- **.format():** The objects can be converted to a custom formatted</span>
<span class="sd">  string using the ``.format()`` method. Example:</span>
<span class="sd">  ``host.format(&quot;{ip} {hostname} {meta.tag}&quot;)``</span>


<span class="sd">Useful Abilities Common to the Unit Types</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">These abilities are common to :py:class:`~viper.Task`, :py:class:`~viper.Host`,</span>
<span class="sd">:py:class:`~viper.Runner` and :py:class:`~viper.Result` unit type objects.</span>

<span class="sd">- **.from_dict() and .to_dict():** Helps representing the objects as Python dictionaries.</span>

<span class="sd">Useful Abilities Common to the Container Types</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">These abilities are common to :py:class:`~viper.Hosts`, :py:class:`~viper.Runners`</span>
<span class="sd">and :py:class:`~viper.Results` container type objects.</span>

<span class="sd">- **.from_items() and .to_items():** The ``.from_items()`` factory method is the</span>
<span class="sd">  recommended way to initialize container type objects. Although it can be a little slower,</span>
<span class="sd">  it removes duplicate items and performs other important checks before initializing</span>
<span class="sd">  the object. It supports sequences, generators, unit objects or all at once.</span>

<span class="sd">  .. attention::</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        # Bad</span>
<span class="sd">        Hosts((host1, host2, host3))</span>

<span class="sd">        # Good</span>
<span class="sd">        Hosts.from_items(host1, host2, host3)</span>

<span class="sd">  The ``.to_items()`` or the alias ``.all()`` returns the tuple of unit items back.</span>

<span class="sd">  Example:</span>

<span class="sd">  .. code-block:: python</span>

<span class="sd">    Hosts.from_items(</span>
<span class="sd">        host1, host2                      # Unit objects</span>
<span class="sd">        [host3, host4],                   # Sequence of objects</span>
<span class="sd">        (host for host in list_of_hosts)  # Generator of objects</span>
<span class="sd">    ).to_items()</span>


<span class="sd">- **.from_file() and to_file():** Container type objects can be initialized from text</span>
<span class="sd">  files and dumped back to text files with certain formats (currently supported `json`,</span>
<span class="sd">  `yml` and `csv`) using these methods.</span>

<span class="sd">  Example:</span>

<span class="sd">  .. code-block:: python</span>

<span class="sd">      Hosts.from_file(&quot;hosts.json&quot;).to_file(&quot;hosts.csv&quot;)</span>

<span class="sd">- **.from_list() and .to_list():** Similar to unit types&#39; ``.from_dict()`` and ``.to_dict()``</span>
<span class="sd">  but operates with list of dictionaries that represent the unit type objects.</span>

<span class="sd">- **.count():** Returns the count of items it holds.</span>

<span class="sd">- **.head() and .tail():** Returns an instance of the same container type object</span>
<span class="sd">  containing first or last n items (n defaults to 10).</span>

<span class="sd">  Example:</span>

<span class="sd">  .. code-block:: python</span>

<span class="sd">    # Get the set of last 5 items from the set of first 10 items.</span>
<span class="sd">    hosts.head(10).tail(5)</span>

<span class="sd">- **.range():** Similar to ``.head()`` or ``.tail()`` but enables us to define both the</span>
<span class="sd">  limits (similar to Python&#39;s ``list[i:j]`` indexing).</span>

<span class="sd">  Example:</span>

<span class="sd">  .. code-block:: python</span>

<span class="sd">    # Exclude the last item (similar to list[0:-1])</span>
<span class="sd">    hosts.range(0, -1)</span>

<span class="sd">- **.sort():** Similar to Python&#39;s ``list.sort()`` but returns a new instance instead of</span>
<span class="sd">  making changes to the existing object (which is impossible because of immutability).</span>

<span class="sd">  Example:</span>

<span class="sd">  .. code-block:: python</span>

<span class="sd">    # Reverse sort by IP, then by hostname</span>
<span class="sd">    hosts.sort(key=lambda host: [host.ip, host.hostname], reverse=True)</span>

<span class="sd">- **.order_by():** Similar to ``.sort()`` but expects the field names instead of a function.</span>
<span class="sd">  Inspired by SQL.</span>

<span class="sd">  Example:</span>

<span class="sd">  .. code-block:: python</span>

<span class="sd">    # Reverse sort by ip, then by hostname</span>
<span class="sd">    hosts.order_by(&quot;ip&quot;, &quot;hostname&quot;, reverse=True)</span>

<span class="sd">- **.filter():** Similar to Python&#39;s ``filter()`` but returns an instance of the same</span>
<span class="sd">  container type object containing the filteres items.</span>

<span class="sd">  Example:</span>

<span class="sd">  .. code-block:: python</span>

<span class="sd">    # Filter hosts where hostname starts with &quot;foo&quot;</span>
<span class="sd">    hosts.filter(lambda host: host.hostname.startswith(&quot;foo&quot;))</span>

<span class="sd">- **.where():** Similar to filter, but expects the and field name, condition</span>
<span class="sd">  and value instead of a function. Inspired by SQL.</span>

<span class="sd">  Example:</span>

<span class="sd">  .. code-block:: python</span>

<span class="sd">    # Filter hosts where hostname starts with &quot;foo&quot;</span>
<span class="sd">    hosts.where(</span>
<span class="sd">        &quot;hostname&quot;, WhereConditions.startswith, [&quot;foo&quot;]</span>
<span class="sd">    )</span>


<span class="sd">More on Task: Command Factories, Output Processors, Callbacks and ...</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">The minimum requirements of defining a :py:class:`~viper.Task` requires is to define</span>
<span class="sd">the task name and the command factory. Optionally, we can also define the stdout and</span>
<span class="sd">stderr processors, and also the pre and post run callbacks.</span>

<span class="sd">The command factory expects a :py:class:`~viper.Host` object and return a tuple of</span>
<span class="sd">string.</span>

<span class="sd">Example:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    def ping_command(host):</span>
<span class="sd">        return &quot;ping&quot;, &quot;-c&quot;, &quot;1&quot;, host.ip</span>

<span class="sd">The stdout and stderr processors expect a string and return a string.</span>

<span class="sd">Example:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    def strip_output(txt):</span>
<span class="sd">        return txt.strip()</span>

<span class="sd">The pre run callback expects a :py:class:`~viper.Runner` object and doesn&#39;t return</span>
<span class="sd">anything. While the post run callback expects a :py:class:`~viper.Result` object and</span>
<span class="sd">doesn&#39;t return anything either.</span>

<span class="sd">Example:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    import sys</span>

<span class="sd">    def log_command_pre_run(runner):</span>
<span class="sd">        command = runner.task.command_factory(runner.host, *runner.args)</span>
<span class="sd">        print(&quot;Running command:&quot;, command, file=sys.stderr)</span>

<span class="sd">    def log_result_post_run(result):</span>
<span class="sd">        print(&quot;OK:&quot; if result.ok() else &quot;ERROR:&quot;, result.host.hostname, file=sys.stderr)</span>


<span class="sd">.. note:: Logs are be printed to `stderr` as `stdout` is for the JSON encoded</span>
<span class="sd">  :py:class:`~viper.Results` object.</span>


<span class="sd">.. attention::</span>

<span class="sd">    The arguments ``command_factory``, ``stdout_processor``, ``stderr_processor``,</span>
<span class="sd">    ``pre_run`` and ``post_run`` callbacks expect normal functions, not lambdas.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        # Bad</span>
<span class="sd">        def ping():</span>
<span class="sd">            return Task(</span>
<span class="sd">                name=&quot;Ping once&quot;,</span>
<span class="sd">                command_factory=lambda host: &quot;ping&quot;, &quot;-c&quot;, &quot;1&quot;, host.ip,</span>
<span class="sd">                stdout_processor=lambda txt: txt.strip(),</span>
<span class="sd">                stderr_processor=lambda txt: txt.strip(),</span>
<span class="sd">                pre_run=lambda runner: print(runner.to_dict(), file=sys.stderr),</span>
<span class="sd">                post_run=lambda result: print(result.to_dict(), file=sys.stderr),</span>
<span class="sd">            )</span>

<span class="sd">        # Good</span>
<span class="sd">        def ping():</span>
<span class="sd">            return Task(</span>
<span class="sd">                name=&quot;Ping once&quot;,</span>
<span class="sd">                command_factory=ping_command,</span>
<span class="sd">                stdout_processor=strip_output,</span>
<span class="sd">                stderr_processor=strip_output,</span>
<span class="sd">                pre_run=log_command_pre_run,</span>
<span class="sd">                post_run=log_result_post_run,</span>
<span class="sd">            )</span>

<span class="sd">Apart from these, a :py:class:`~viper.Task` also optionally expects ``timeout``,</span>
<span class="sd">``retry`` and ``meta``.</span>

<span class="sd">- **timeout:** The execution will timeout after the specified seconds if timeout is</span>
<span class="sd">  defined.</span>

<span class="sd">  The countdown doesn&#39;t count the time spent on the pre and post run</span>
<span class="sd">  callbacks, neither the command factory invocation. It only counts time spent on</span>
<span class="sd">  executing the generated command.</span>

<span class="sd">- **retry:** It defaults to 0. If more than 0, The runner will re-invoke the</span>
<span class="sd">  :py:meth:`~viper.Runner.run` method with the updated retry value if the</span>
<span class="sd">  command execution fails. The results generated for these retries will be stored</span>
<span class="sd">  in DB and will be available in history. They will have the same ``trigger_time`` but</span>
<span class="sd">  different ``start`` and ``end`` times.</span>

<span class="sd">  However, if the failure is caused by any reason other than the actual command</span>
<span class="sd">  invocation, such as while invoking the command factory or output processors or</span>
<span class="sd">  pre/post run callbacks, a Python error will be raised which won&#39;t be stored in DB.</span>
<span class="sd">  If any such error occurs while running the task in batch, it will be ignored with</span>
<span class="sd">  the traceback printed on stderr.</span>

<span class="sd">- **meta:** It is the same as the ``meta`` field in :py:class:`~viper.Host`. It should</span>
<span class="sd">  be generated only using the :py:func:`viper.meta` function.</span>

<span class="sd">  .. attention::</span>

<span class="sd">      .. code-block:: python</span>

<span class="sd">        # Bad</span>
<span class="sd">        def ping():</span>
<span class="sd">            return Task(</span>
<span class="sd">                name=&quot;Ping once&quot;,</span>
<span class="sd">                command_factory=ping_command,</span>
<span class="sd">                meta={&quot;tag&quot;: &quot;foo&quot;},</span>
<span class="sd">            )</span>

<span class="sd">        # Good</span>
<span class="sd">        def ping():</span>
<span class="sd">            return Task(</span>
<span class="sd">                name=&quot;Ping once&quot;,</span>
<span class="sd">                command_factory=ping_command,</span>
<span class="sd">                meta=meta(tag=&quot;foo&quot;)</span>
<span class="sd">            )</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">as_completed</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dumps</span> <span class="k">as</span> <span class="n">dumpjson</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">loads</span> <span class="k">as</span> <span class="n">loadjson</span>
<span class="kn">from</span> <span class="nn">pydoc</span> <span class="kn">import</span> <span class="n">locate</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FunctionType</span>
<span class="kn">from</span> <span class="nn">viper.const</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">viper.db</span> <span class="kn">import</span> <span class="n">ViperDB</span>
<span class="kn">from</span> <span class="nn">viper.serializers</span> <span class="kn">import</span> <span class="n">Serializers</span>
<span class="kn">from</span> <span class="nn">viper.utils</span> <span class="kn">import</span> <span class="n">flatten_dict</span>
<span class="kn">from</span> <span class="nn">viper.utils</span> <span class="kn">import</span> <span class="n">optional</span>
<span class="kn">from</span> <span class="nn">viper.utils</span> <span class="kn">import</span> <span class="n">required</span>
<span class="kn">from</span> <span class="nn">viper.utils</span> <span class="kn">import</span> <span class="n">unflatten_dict</span>

<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;WhereConditions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Collection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;meta&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Item&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Items&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Host&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Hosts&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Task&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Runner&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Runners&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Result&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Results&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">T</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
<span class="n">CollectionType</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;CollectionType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;Collection&quot;</span><span class="p">)</span>
<span class="n">ItemType</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;ItemType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;Item&quot;</span><span class="p">)</span>
<span class="n">ItemsType</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;ItemsType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;Items[t.Any]&quot;</span><span class="p">)</span>
<span class="n">JSONValueType</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>


<div class="viewcode-block" id="WhereConditions"><a class="viewcode-back" href="../../viper.html#viper.collections.WhereConditions">[docs]</a><span class="k">class</span> <span class="nc">WhereConditions</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Where query conditions for viper Items.</span>

<span class="sd">    :example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        Hosts.from_items(</span>
<span class="sd">            Hosts(&#39;1.1.1.1&#39;),</span>
<span class="sd">            Hosts(&#39;2.2.2.2&#39;),</span>
<span class="sd">        ).where(&quot;ip&quot;, WhereConditions.is_, &#39;1.1.1.1&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">is_</span> <span class="o">=</span> <span class="s2">&quot;IS&quot;</span>
    <span class="n">is_not</span> <span class="o">=</span> <span class="s2">&quot;IS_NOT&quot;</span>
    <span class="n">contains</span> <span class="o">=</span> <span class="s2">&quot;CONTAINS&quot;</span>
    <span class="n">not_contains</span> <span class="o">=</span> <span class="s2">&quot;NOT_CONTAINS&quot;</span>
    <span class="n">startswith</span> <span class="o">=</span> <span class="s2">&quot;STARTSWITH&quot;</span>
    <span class="n">not_startswith</span> <span class="o">=</span> <span class="s2">&quot;NOT_STARTSWITH&quot;</span>
    <span class="n">endswith</span> <span class="o">=</span> <span class="s2">&quot;ENDSWITH&quot;</span>
    <span class="n">not_endswith</span> <span class="o">=</span> <span class="s2">&quot;NOT_ENDSWITH&quot;</span></div>


<div class="viewcode-block" id="meta"><a class="viewcode-back" href="../../viper.html#viper.collections.meta">[docs]</a><span class="k">def</span> <span class="nf">meta</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">:</span> <span class="n">JSONValueType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Meta data object creator.</span>

<span class="sd">    :param `**mapping`: key-value pairs as the meta data.</span>
<span class="sd">    :example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from viper import Host, meta</span>

<span class="sd">        host = Host(&#39;1.1.1.1&#39;, meta=meta(provider=&quot;aws&quot;))</span>
<span class="sd">        host.meta.provider</span>
<span class="sd">        # &#39;aws&#39;</span>
<span class="sd">        host.meta[&#39;provider&#39;]</span>
<span class="sd">        # &#39;aws&#39;</span>
<span class="sd">        host[&#39;meta&#39;][&#39;provider&#39;]</span>
<span class="sd">        # &#39;aws&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">BaseMeta</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Meta&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># type: ignore</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="n">BaseMeta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Meta data of an item using namedtuple</span>
<span class="sd">        customized to supports dict-like indexing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dumpjson</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_asdict</span><span class="p">())</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Meta</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>


<div class="viewcode-block" id="Collection"><a class="viewcode-back" href="../../viper.html#viper.collections.Collection">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Collection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The base collection class.</span>

<span class="sd">    This is the parent class for all Viper native objects such as</span>
<span class="sd">    :py:class:`viper.collections.Host`, :py:class:`viper.collections.Results` etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>

<div class="viewcode-block" id="Collection.from_json"><a class="viewcode-back" href="../../viper.html#viper.collections.Collection.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">CollectionType</span><span class="p">],</span>
        <span class="n">json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
        <span class="n">unflatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionType</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Initialise a new object of this class from the given JSON string.</span>

<span class="sd">        :param str json: The JSON data to parse.</span>
<span class="sd">        :param `*args` and `**kwargs`: These will be passed to `json.laods`.</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Hosts.from_json(&#39;[{&quot;ip&quot;: &quot;1.1.1.1&quot;}]&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Collection.to_json"><a class="viewcode-back" href="../../viper.html#viper.collections.Collection.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Represent the collection as JSON data.</span>

<span class="sd">        :param object `*args` and `**kwargs`: These will be passed to ``json.laods``.</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Host(&quot;1.2.3.4&quot;).to_json(indent=4)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Collection.from_func"><a class="viewcode-back" href="../../viper.html#viper.collections.Collection.from_func">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_func</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">CollectionType</span><span class="p">],</span> <span class="n">funcpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CollectionType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load the object from the given Python function.</span>

<span class="sd">        :param str funcpath: The path to a Python function that returns an</span>
<span class="sd">            instance of this class.</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Task.from_func(&quot;task.ping&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">func</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="n">locate</span><span class="p">(</span><span class="n">funcpath</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not resolve {repr(funcpath)}.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;{repr(funcpath)} is not callable.&quot;</span><span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;{repr(funcpath)} does not produce a valid </span><span class="si">{cls}</span><span class="s2"> instance.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="Collection.pipe"><a class="viewcode-back" href="../../viper.html#viper.collections.Collection.pipe">[docs]</a>    <span class="k">def</span> <span class="nf">pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Pipe this object to the given function.</span>

<span class="sd">        :param callable handler: A callable that expects this object.</span>
<span class="sd">        :param object args: Arguments to be passed to the handler for decision making.</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Hosts.from_items(Host(&quot;1.2.3.4&quot;)).pipe(hosts2csv)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{handler}</span><span class="s2">: expected a callable but got {type(handler)}&quot;</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Collection.hash"><a class="viewcode-back" href="../../viper.html#viper.collections.Collection.hash">[docs]</a>    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the hash value.</span>

<span class="sd">        By convention all Viper native objects are frozen and thus hashable.</span>

<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Item"><a class="viewcode-back" href="../../viper.html#viper.collections.Item">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">Collection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The base class for a single Viper object.</span>

<span class="sd">    :py:class:`viper.collections.Host`, :py:class:`viper.collections.Task` etc. inherits this base class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="Item.from_dict"><a class="viewcode-back" href="../../viper.html#viper.collections.Item.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">ItemType</span><span class="p">],</span>
        <span class="n">dict_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">unflatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemType</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Initialize item from the given dict.</span>

<span class="sd">        :param dict dict_: The dictionary containing the properties for this object.</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Host.from_dict({&quot;ip&quot;: &quot;1.2.3.4&quot;})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Item.to_dict"><a class="viewcode-back" href="../../viper.html#viper.collections.Item.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Represent the item as dict.</span>

<span class="sd">        :param bool flatten: If true, the dict won&#39;t be nested.</span>
<span class="sd">        :rtype: dict</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Host(&quot;1.2.3.4&quot;).to_dict()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Item.from_json"><a class="viewcode-back" href="../../viper.html#viper.collections.Item.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">ItemType</span><span class="p">],</span>
        <span class="n">json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
        <span class="n">unflatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemType</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">loadjson</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">unflatten</span><span class="o">=</span><span class="n">unflatten</span><span class="p">)</span></div>

<div class="viewcode-block" id="Item.to_json"><a class="viewcode-back" href="../../viper.html#viper.collections.Item.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dumpjson</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">flatten</span><span class="o">=</span><span class="n">flatten</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Item.format"><a class="viewcode-back" href="../../viper.html#viper.collections.Item.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a custom string representation of this object.</span>

<span class="sd">        :param str template: The template to be used as `&quot;template&quot;.format(**vars(self))`</span>
<span class="sd">        :rtype: str</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Host(&quot;1.2.3.4&quot;).format(&quot;{ip} {hostname} {meta.tag}&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="Items"><a class="viewcode-back" href="../../viper.html#viper.collections.Items">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Items</span><span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;The base class for collection objects for a group of similar items.</span>

<span class="sd">    :py:class:`viper.collections.Hosts`, :py:class:`viper.collections.Results` etc. inherits this base class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_all</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">tuple</span><span class="p">)</span>
    <span class="n">_item_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Item</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="Items.from_items"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.from_items">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_items</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">ItemsType</span><span class="p">],</span> <span class="o">*</span><span class="n">items</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">T</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create this an instance of this object using the given items.</span>

<span class="sd">        :param viper.collections.Item items: The group of items to hold.</span>

<span class="sd">        :rtype: viper.collections.Items</span>

<span class="sd">        .. note::</span>
<span class="sd">            Classes that inherits from :py:class:`Items` should not be</span>
<span class="sd">            initialized directly (e.g. ``Hosts(Host(&quot;1.2.3.4&quot;))``). Factory</span>
<span class="sd">            methods such as this should be used instead.</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            Hosts.from_items(Host(&quot;1.2.3.4&quot;))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">items_set</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">Item</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Item</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{item}</span><span class="s2">: expecting </span><span class="si">{Item}</span><span class="s2"> or generator of &#39;Item&#39;s but got {type(item)}&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Item</span><span class="p">):</span>
                <span class="n">items_set</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Item</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{i}</span><span class="s2">: expecting </span><span class="si">{Item}</span><span class="s2"> but got {type(i)}&quot;</span><span class="p">)</span>
                    <span class="n">items_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">items_set</span><span class="p">))</span></div>

<div class="viewcode-block" id="Items.from_list"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.from_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_list</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">ItemsType</span><span class="p">],</span>
        <span class="n">list_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">]],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">unflatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize items from given list of dictiionaries.</span>

<span class="sd">        :param list list_: The list of dictiionaries containing the item properties.</span>

<span class="sd">        :rtype: viper.collections.Items</span>

<span class="sd">        This is used for loading JSON data into an instance of this class.</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            Hosts.from_list([{&quot;ip&quot;: &quot;1.2.3.4&quot;}])</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_item_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_item_type</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">unflatten</span><span class="o">=</span><span class="n">unflatten</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid input data for </span><span class="si">{cls.__name__}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Items.to_list"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.to_list">[docs]</a>    <span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Represent the items as a list of dictiionaries.</span>

<span class="sd">        This is used for dumping an instance of this object as JSON data.</span>

<span class="sd">        :param bool flatten: If True, dicts won&#39;t be nested.</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            Hosts.from_items(Host(&quot;1.2.3.4&quot;)).to_list()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">flatten</span><span class="o">=</span><span class="n">flatten</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Item</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Items.from_json"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">ItemsType</span><span class="p">],</span>
        <span class="n">json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
        <span class="n">unflatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="n">loadjson</span><span class="p">(</span><span class="n">json</span><span class="p">),</span> <span class="n">unflatten</span><span class="o">=</span><span class="n">unflatten</span><span class="p">)</span></div>

<div class="viewcode-block" id="Items.to_json"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>

        <span class="k">return</span> <span class="n">dumpjson</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">flatten</span><span class="o">=</span><span class="n">flatten</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Items.from_file"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">ItemsType</span><span class="p">],</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize items by reading data from a file.</span>

<span class="sd">        :param filepath str: The path for the file to read from.</span>
<span class="sd">        :rtype: viper.collections.Items</span>
<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Hosts.from_file(&quot;/path/to/file/hosts.json&quot;)</span>

<span class="sd">            Hosts.from_file(&quot;/path/to/file/hosts.csv&quot;)</span>

<span class="sd">            Hosts.from_file(&quot;/path/to/file/hosts.yml&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{filepath}</span><span class="s2">: file extension is missing&quot;</span><span class="p">)</span>

        <span class="n">ext</span> <span class="o">=</span> <span class="n">filepath</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">extensions</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">Serializers</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{filepath}</span><span class="s2">: </span><span class="si">{ext}</span><span class="s2">: extension is not supported, use one of </span><span class="si">{extensions}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="n">Serializers</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">unflatten</span><span class="o">=</span><span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Items.to_file"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.to_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ItemsType</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize items by reading data from a file.</span>

<span class="sd">        :param filepath str: The path for the file to write.</span>
<span class="sd">        :rtype: viper.collections.Items</span>
<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Hosts.from_items(Host(&quot;1.2.3.4&quot;)).to_file(&quot;/path/to/file/hosts.json&quot;)</span>

<span class="sd">            Hosts.from_items(Host(&quot;1.2.3.4&quot;)).to_file(&quot;/path/to/file/hosts.csv&quot;)</span>

<span class="sd">            Hosts.from_items(Host(&quot;1.2.3.4&quot;)).to_file(&quot;/path/to/file/hosts.yml&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{filepath}</span><span class="s2">: file extension is missing&quot;</span><span class="p">)</span>

        <span class="n">ext</span> <span class="o">=</span> <span class="n">filepath</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">extensions</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">Serializers</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{filepath}</span><span class="s2">: </span><span class="si">{ext}</span><span class="s2">: extension is not supported, use one of </span><span class="si">{extensions}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="n">Serializers</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">flatten</span><span class="o">=</span><span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">))))</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">)</span>

<div class="viewcode-block" id="Items.count"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Count the number of items.</span>

<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Items.head"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.head">[docs]</a>    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ItemsType</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the first &#39;n&#39; items from the group of items.</span>

<span class="sd">        Works like Python&#39;s [:n] index</span>

<span class="sd">        :rtype: viper.collections.Item</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span></div>

<div class="viewcode-block" id="Items.tail"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.tail">[docs]</a>    <span class="k">def</span> <span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ItemsType</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the last &#39;n&#39; item from the group of items.</span>

<span class="sd">        Works like Python&#39;s [-n:] index</span>

<span class="sd">        :rtype: viper.collections.Item</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span></div>

<div class="viewcode-block" id="Items.range"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.range">[docs]</a>    <span class="k">def</span> <span class="nf">range</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">ItemsType</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;get the items in given range.</span>

<span class="sd">        :param int i (optional): The first index.</span>
<span class="sd">        :param int j (optional): The last index.</span>

<span class="sd">        :rtype: Items</span>

<span class="sd">        This has the same behaviour as Python&#39;s [i:j]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span></div>

<div class="viewcode-block" id="Items.sort"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.sort">[docs]</a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">ItemsType</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Item</span><span class="p">],</span> <span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sort the items by given key/function.</span>

<span class="sd">        :param callable key: A function similar to the one passed to the built-in `sorted()`.</span>
<span class="sd">        :param bool reverse: Reverse the order after sort.</span>

<span class="sd">        :rtype: Items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Items.order_by"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.order_by">[docs]</a>    <span class="k">def</span> <span class="nf">order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ItemsType</span><span class="p">,</span> <span class="o">*</span><span class="n">properties</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sort the items by multiple properties</span>

<span class="sd">        :param list properties: The item will be sorted by the given properties in order.</span>
<span class="sd">        :param bool reverse: Reverse the order after sort.</span>

<span class="sd">        :rtype: Items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span>
            <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;{{</span><span class="si">{p}</span><span class="s2">}}&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">],</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Items.filter"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ItemsType</span><span class="p">,</span> <span class="n">filter_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Filter the items by a given function.</span>

<span class="sd">        :param callable filter_: A function that returns either True or False.</span>
<span class="sd">        :param object args: Arguments to be passed to the filter to manipulate the decision making.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">filter_</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{filter_}</span><span class="s2">: expected a callable, but got {type(filter_)}&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">filter_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Items.to_items"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.to_items">[docs]</a>    <span class="k">def</span> <span class="nf">to_items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get a tuple of all the items.</span>

<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span></div>

<div class="viewcode-block" id="Items.all"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.all">[docs]</a>    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Alias for .to_items()&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_items</span><span class="p">()</span></div>

<div class="viewcode-block" id="Items.format"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ItemsType</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a custom string representation of this list of objects.</span>

<span class="sd">        :param str template: The template will be compiled by Python&#39;s `.format()`.</span>
<span class="sd">        :param str sep: The separator used to separate all the items.</span>

<span class="sd">        :rtype: str</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Hosts.from_items(Host(&quot;1.2.3.4&quot;)).format(&quot;{ip} {hostname} {meta.tag}&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">template</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">)</span></div>

<div class="viewcode-block" id="Items.where"><a class="viewcode-back" href="../../viper.html#viper.collections.Items.where">[docs]</a>    <span class="k">def</span> <span class="nf">where</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">ItemsType</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">WhereConditions</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ItemsType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Select items by a custom query.</span>

<span class="sd">        :param str key: The key will be compiled by Python&#39;s `.format()`.</span>
<span class="sd">        :param viper.collections.WhereConditions condition: The where condition.</span>
<span class="sd">        :param list values: The values for the key.</span>
<span class="sd">        :rtype: Items</span>
<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Hosts.from_items(</span>
<span class="sd">                Host(&quot;1.1.1.1&quot;),</span>
<span class="sd">                Host(&quot;2.2.2.2&quot;)</span>
<span class="sd">            ).where(&quot;ip&quot;, WhereConditions.is_, [&quot;1.1.1.1&quot;])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;{{</span><span class="si">{key}</span><span class="s2">}}&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">condition</span> <span class="ow">is</span> <span class="n">WhereConditions</span><span class="o">.</span><span class="n">is_</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">condition</span> <span class="ow">is</span> <span class="n">WhereConditions</span><span class="o">.</span><span class="n">is_not</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">condition</span> <span class="ow">is</span> <span class="n">WhereConditions</span><span class="o">.</span><span class="n">contains</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">,</span> <span class="n">values</span><span class="p">)):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">condition</span> <span class="ow">is</span> <span class="n">WhereConditions</span><span class="o">.</span><span class="n">not_contains</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">,</span> <span class="n">values</span><span class="p">)):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">condition</span> <span class="ow">is</span> <span class="n">WhereConditions</span><span class="o">.</span><span class="n">startswith</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">values</span><span class="p">)):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">condition</span> <span class="ow">is</span> <span class="n">WhereConditions</span><span class="o">.</span><span class="n">not_startswith</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">values</span><span class="p">)):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">condition</span> <span class="ow">is</span> <span class="n">WhereConditions</span><span class="o">.</span><span class="n">endswith</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">values</span><span class="p">)):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">condition</span> <span class="ow">is</span> <span class="n">WhereConditions</span><span class="o">.</span><span class="n">not_endswith</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">values</span><span class="p">)):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;expecting enum </span><span class="si">{WhereConditions}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Host"><a class="viewcode-back" href="../../viper.html#viper.collections.Host">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Host</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Viper Host class.&quot;&quot;&quot;</span>

    <span class="n">ip</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">hostname</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">domain</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="n">login_name</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">identity_file</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">meta</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">==</span> <span class="n">value</span><span class="o">.</span><span class="n">ip</span>

<div class="viewcode-block" id="Host.from_dict"><a class="viewcode-back" href="../../viper.html#viper.collections.Host.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Host</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">unflatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Host</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">unflatten</span><span class="p">:</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="n">unflatten_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>
        <span class="n">ip</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;ip&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">optional</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;hostname&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">optional</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;domain&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="n">login_name</span> <span class="o">=</span> <span class="n">optional</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;login_name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">identity_file</span> <span class="o">=</span> <span class="n">optional</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;identity_file&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">meta_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">=</span> <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;meta&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{})</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
            <span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
            <span class="n">login_name</span><span class="o">=</span><span class="n">login_name</span><span class="p">,</span>
            <span class="n">identity_file</span><span class="o">=</span><span class="n">identity_file</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">(</span><span class="o">**</span><span class="n">meta_</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">host</span></div>

<div class="viewcode-block" id="Host.to_dict"><a class="viewcode-back" href="../../viper.html#viper.collections.Host.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">_asdict</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dict_</span></div>

<div class="viewcode-block" id="Host.fqdn"><a class="viewcode-back" href="../../viper.html#viper.collections.Host.fqdn">[docs]</a>    <span class="k">def</span> <span class="nf">fqdn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the FQDN from hostname and domain name.</span>

<span class="sd">        :rtype: str</span>

<span class="sd">        :raises ValueError: If either of hostname or domain name is not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;hostname and domain not set&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;hostname not set&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;domain not set&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{self.hostname}</span><span class="s2">.</span><span class="si">{self.domain}</span><span class="s2">&quot;</span></div>

<div class="viewcode-block" id="Host.task"><a class="viewcode-back" href="../../viper.html#viper.collections.Host.task">[docs]</a>    <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runner</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Assigns a task to be run.</span>

<span class="sd">        :param viper.collections.Task task: The task to be assigned.</span>
<span class="sd">        :param str args: The arguments to be used to create the command from `command_factory`.</span>

<span class="sd">        :rtype: viper.collections.Runner</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Host(&quot;1.2.3.4&quot;).task(ping)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Runner</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="Host.run_task"><a class="viewcode-back" href="../../viper.html#viper.collections.Host.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Assign the task to the host and then run it.</span>

<span class="sd">        :param viper.collections.Task task: The task to be assigned.</span>
<span class="sd">        :param str args: The arguments to be used to create the command</span>
<span class="sd">            from :py:attr:`viper.collections.Task.command_factory`.</span>

<span class="sd">        :rtype: viper.collections.Result</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Host(&quot;1.2.3.4&quot;).task_task(ping)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="Host.results"><a class="viewcode-back" href="../../viper.html#viper.collections.Host.results">[docs]</a>    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Results</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch recent results of current host from database.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Results</span><span class="o">.</span><span class="n">by_host</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Hosts"><a class="viewcode-back" href="../../viper.html#viper.collections.Hosts">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Hosts</span><span class="p">(</span><span class="n">Items</span><span class="p">[</span><span class="n">Host</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;A group of :py:class:`viper.collections.Host` objects.&quot;&quot;&quot;</span>

    <span class="n">_all</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Host</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">tuple</span><span class="p">)</span>
    <span class="n">_item_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Host</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Host</span><span class="p">)</span>

<div class="viewcode-block" id="Hosts.task"><a class="viewcode-back" href="../../viper.html#viper.collections.Hosts.task">[docs]</a>    <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runners</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Assigns a task to be run on each host in the group.</span>

<span class="sd">        :param viper.collections.Task task: The task to be assigned.</span>
<span class="sd">        :param str args: The arguments to be used to create the command from `command_factory`.</span>

<span class="sd">        :rtype: viper.collections.Runners</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Hosts.from_items(Host(&quot;1.2.3.4&quot;)).task(ping)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Runners</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span>
            <span class="n">Runner</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Hosts.run_task"><a class="viewcode-back" href="../../viper.html#viper.collections.Hosts.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">max_workers</span><span class="o">.</span><span class="n">value</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Results</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Assign the task to the host and then run it.</span>

<span class="sd">        :param viper.collections.Task task: The task to be assigned.</span>
<span class="sd">        :param str args: The arguments to be used to create the command</span>
<span class="sd">            from :py:attr:`viper.collections.Task.command_factory`.</span>
<span class="sd">        :param int max_workers: Maximum number of thread workers.</span>
<span class="sd">            if the value is &lt;= 1, tasks will run in sequence.</span>

<span class="sd">        :rtype: viper.collections.Results</span>

<span class="sd">        :example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Hosts.from_items(Host(&quot;1.2.3.4&quot;)).task_task(ping)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hosts.results"><a class="viewcode-back" href="../../viper.html#viper.collections.Hosts.results">[docs]</a>    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Results</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the past results of this group of hosts from history.</span>

<span class="sd">        :rtype: viper.collections.Results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">results</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Results</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Task"><a class="viewcode-back" href="../../viper.html#viper.collections.Task">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A task is a definition of a single operation.</span>

<span class="sd">    A task must contain name and a **named function** to generate the</span>
<span class="sd">    command.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">command_factory</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">stdout_processor</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stderr_processor</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pre_run</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Runner</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">post_run</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Result</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">meta</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

<div class="viewcode-block" id="Task.from_dict"><a class="viewcode-back" href="../../viper.html#viper.collections.Task.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Task</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">unflatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Task</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">unflatten</span><span class="p">:</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="n">unflatten_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>

        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="n">command_factory</span><span class="p">:</span> <span class="n">FunctionType</span> <span class="o">=</span> <span class="n">required</span><span class="p">(</span>
            <span class="n">dict_</span><span class="p">,</span>
            <span class="s2">&quot;command_factory&quot;</span><span class="p">,</span>
            <span class="n">FunctionType</span><span class="p">,</span>
            <span class="n">parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">locate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))),</span>
        <span class="p">)</span>

        <span class="n">timeout</span> <span class="o">=</span> <span class="n">optional</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,))</span>

        <span class="n">retry</span> <span class="o">=</span> <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;retry&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">stdout_processor</span> <span class="o">=</span> <span class="n">optional</span><span class="p">(</span>
            <span class="n">dict_</span><span class="p">,</span>
            <span class="s2">&quot;stdout_processor&quot;</span><span class="p">,</span>
            <span class="n">FunctionType</span><span class="p">,</span>
            <span class="n">parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">locate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))),</span>
        <span class="p">)</span>

        <span class="n">stderr_processor</span> <span class="o">=</span> <span class="n">optional</span><span class="p">(</span>
            <span class="n">dict_</span><span class="p">,</span>
            <span class="s2">&quot;stderr_processor&quot;</span><span class="p">,</span>
            <span class="n">FunctionType</span><span class="p">,</span>
            <span class="n">parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">locate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))),</span>
        <span class="p">)</span>

        <span class="n">pre_run</span> <span class="o">=</span> <span class="n">optional</span><span class="p">(</span>
            <span class="n">dict_</span><span class="p">,</span>
            <span class="s2">&quot;pre_run&quot;</span><span class="p">,</span>
            <span class="n">FunctionType</span><span class="p">,</span>
            <span class="n">parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">locate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))),</span>
        <span class="p">)</span>

        <span class="n">post_run</span> <span class="o">=</span> <span class="n">optional</span><span class="p">(</span>
            <span class="n">dict_</span><span class="p">,</span>
            <span class="s2">&quot;post_run&quot;</span><span class="p">,</span>
            <span class="n">FunctionType</span><span class="p">,</span>
            <span class="n">parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">locate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))),</span>
        <span class="p">)</span>

        <span class="n">meta_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span> <span class="o">=</span> <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;meta&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{})</span>

        <span class="n">hosts</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">command_factory</span><span class="o">=</span><span class="n">command_factory</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">,</span>
            <span class="n">stdout_processor</span><span class="o">=</span><span class="n">stdout_processor</span><span class="p">,</span>
            <span class="n">stderr_processor</span><span class="o">=</span><span class="n">stderr_processor</span><span class="p">,</span>
            <span class="n">pre_run</span><span class="o">=</span><span class="n">pre_run</span><span class="p">,</span>
            <span class="n">post_run</span><span class="o">=</span><span class="n">post_run</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">(</span><span class="o">**</span><span class="n">meta_</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hosts</span></div>

<div class="viewcode-block" id="Task.to_dict"><a class="viewcode-back" href="../../viper.html#viper.collections.Task.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_factory</span>
        <span class="n">outp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout_processor</span>
        <span class="n">errp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_processor</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_run</span>
        <span class="n">post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_run</span>

        <span class="n">dict_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="n">command_factory</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{cf.__module__}</span><span class="s2">.</span><span class="si">{cf.__qualname__}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">stdout_processor</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{outp.__module__}</span><span class="s2">.</span><span class="si">{outp.__qualname__}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">outp</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">stderr_processor</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{errp.__module__}</span><span class="s2">.</span><span class="si">{errp.__qualname__}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">errp</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">pre_run</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{pre.__module__}</span><span class="s2">.</span><span class="si">{pre.__qualname__}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">pre</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">post_run</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{post.__module__}</span><span class="s2">.</span><span class="si">{post.__qualname__}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">post</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">_asdict</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dict_</span></div>

<div class="viewcode-block" id="Task.results"><a class="viewcode-back" href="../../viper.html#viper.collections.Task.results">[docs]</a>    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Results</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the past results of this task.</span>

<span class="sd">        :rtype: Rviper.collections.esults</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Results</span><span class="o">.</span><span class="n">by_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Runner"><a class="viewcode-back" href="../../viper.html#viper.collections.Runner">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Runner</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A single task runner.</span>

<span class="sd">    A runner owns the responsibility of actually generating and running</span>
<span class="sd">    the command, store the result, calling, retrying, etc.</span>
<span class="sd">    We generally do not use it directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">host</span><span class="p">:</span> <span class="n">Host</span>
    <span class="n">task</span><span class="p">:</span> <span class="n">Task</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="Runner.from_dict"><a class="viewcode-back" href="../../viper.html#viper.collections.Runner.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Runner</span><span class="p">],</span>
        <span class="n">dict_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">unflatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runner</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">unflatten</span><span class="p">:</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="n">unflatten_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>

        <span class="n">host</span><span class="p">:</span> <span class="n">Host</span> <span class="o">=</span> <span class="n">required</span><span class="p">(</span>
            <span class="n">dict_</span><span class="p">,</span>
            <span class="s2">&quot;host&quot;</span><span class="p">,</span>
            <span class="n">Host</span><span class="p">,</span>
            <span class="n">parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Host</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">task</span><span class="p">:</span> <span class="n">Task</span> <span class="o">=</span> <span class="n">required</span><span class="p">(</span>
            <span class="n">dict_</span><span class="p">,</span>
            <span class="s2">&quot;task&quot;</span><span class="p">,</span>
            <span class="n">Task</span><span class="p">,</span>
            <span class="n">parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Task</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="Runner.to_dict"><a class="viewcode-back" href="../../viper.html#viper.collections.Runner.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="n">args</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dict_</span></div>

<div class="viewcode-block" id="Runner.run"><a class="viewcode-back" href="../../viper.html#viper.collections.Runner.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trigger_time</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run the task on the host.</span>

<span class="sd">        :param int retry: Count of retries used.</span>
<span class="sd">        :param float trigger_time (optional): The trigger time used for grouping (auto generated).</span>

<span class="sd">        :rtype: viper.collections.Result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trigger_time</span><span class="p">:</span>
            <span class="n">trigger_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{self.args}</span><span class="s2">: args must be a list/tuple of strings.&quot;</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">command_factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">command</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{self.task.command_factory}</span><span class="s2"> generated empty command (</span><span class="si">{command}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">command</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{command}</span><span class="s2">: command must be a list/tuple of strings.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">pre_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">pre_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">command</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin1&quot;</span><span class="p">,</span>
                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">returncode</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">returncode</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">returncode</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">123</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">stdout_processor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">stdout_processor</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">stderr_processor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">stderr_processor</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span>
            <span class="n">trigger_time</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
            <span class="n">command</span><span class="p">,</span>
            <span class="n">stdout</span><span class="p">,</span>
            <span class="n">stderr</span><span class="p">,</span>
            <span class="n">returncode</span><span class="p">,</span>
            <span class="n">start</span><span class="p">,</span>
            <span class="n">end</span><span class="p">,</span>
            <span class="n">retry</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">post_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">post_run</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">errored</span><span class="p">()</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">retry_left</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">trigger_time</span><span class="o">=</span><span class="n">trigger_time</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="Runners"><a class="viewcode-back" href="../../viper.html#viper.collections.Runners">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Runners</span><span class="p">(</span><span class="n">Items</span><span class="p">[</span><span class="n">Runner</span><span class="p">]):</span>
    <span class="n">_all</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Runner</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">tuple</span><span class="p">)</span>
    <span class="n">_item_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Runner</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Runner</span><span class="p">)</span>

<div class="viewcode-block" id="Runners.run"><a class="viewcode-back" href="../../viper.html#viper.collections.Runners.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">max_workers</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Results</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run the tasks.</span>

<span class="sd">        :param int max_workers: Maximum number of thread workers to use.</span>

<span class="sd">        :rtype: viper.collections.Results</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trigger_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">max_workers</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Run in sequence</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">trigger_time</span><span class="o">=</span><span class="n">trigger_time</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Results</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="c1"># Run in parallel</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;trigger_time&quot;</span><span class="p">:</span> <span class="n">trigger_time</span><span class="p">})</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span>
            <span class="p">]</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Results</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Runners.hosts"><a class="viewcode-back" href="../../viper.html#viper.collections.Runners.hosts">[docs]</a>    <span class="k">def</span> <span class="nf">hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hosts</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the list of hosts from the runners.</span>

<span class="sd">        :rtype: viper.collections.Hosts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Hosts</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">host</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Result"><a class="viewcode-back" href="../../viper.html#viper.collections.Result">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Result</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The result of an executed task.&quot;&quot;&quot;</span>

    <span class="n">trigger_time</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">task</span><span class="p">:</span> <span class="n">Task</span>
    <span class="n">host</span><span class="p">:</span> <span class="n">Host</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">end</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span>

<div class="viewcode-block" id="Result.by_id"><a class="viewcode-back" href="../../viper.html#viper.collections.Result.by_id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">by_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">id_</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the result from DB by hash.</span>

<span class="sd">        :param int hash_: The hash value.</span>

<span class="sd">        :rtype: viper.collections.Result</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">ViperDB</span><span class="p">(</span><span class="n">ViperDB</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>

            <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    SELECT</span>
<span class="sd">                        trigger_time, task, host, args, command, stdout, stderr,</span>
<span class="sd">                        returncode, start, end, retry</span>
<span class="sd">                    FROM results WHERE id = ?</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">id_</span><span class="p">,),</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">trigger_time</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">task</span><span class="o">=</span><span class="n">loadjson</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">host</span><span class="o">=</span><span class="n">loadjson</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">args</span><span class="o">=</span><span class="n">loadjson</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                <span class="n">command</span><span class="o">=</span><span class="n">loadjson</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                <span class="n">returncode</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                <span class="n">start</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                <span class="n">end</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                <span class="n">retry</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Result.from_dict"><a class="viewcode-back" href="../../viper.html#viper.collections.Result.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Result</span><span class="p">],</span>
        <span class="n">dict_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">unflatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">unflatten</span><span class="p">:</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="n">unflatten_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">trigger_time</span><span class="o">=</span><span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;trigger_time&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
            <span class="n">task</span><span class="o">=</span><span class="n">required</span><span class="p">(</span>
                <span class="n">dict_</span><span class="p">,</span>
                <span class="s2">&quot;task&quot;</span><span class="p">,</span>
                <span class="n">Task</span><span class="p">,</span>
                <span class="n">parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Task</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                    <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">host</span><span class="o">=</span><span class="n">required</span><span class="p">(</span>
                <span class="n">dict_</span><span class="p">,</span>
                <span class="s2">&quot;host&quot;</span><span class="p">,</span>
                <span class="n">Host</span><span class="p">,</span>
                <span class="n">parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Host</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                    <span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">args</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)),</span>
            <span class="n">command</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)),</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="n">returncode</span><span class="o">=</span><span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;returncode&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="n">start</span><span class="o">=</span><span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">required</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="s2">&quot;retry&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Result.to_dict"><a class="viewcode-back" href="../../viper.html#viper.collections.Result.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="n">args</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dict_</span></div>

<div class="viewcode-block" id="Result.ok"><a class="viewcode-back" href="../../viper.html#viper.collections.Result.ok">[docs]</a>    <span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns True the result is success.</span>

<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Result.errored"><a class="viewcode-back" href="../../viper.html#viper.collections.Result.errored">[docs]</a>    <span class="k">def</span> <span class="nf">errored</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;returns True if the result is failure.</span>

<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Result.retry_left"><a class="viewcode-back" href="../../viper.html#viper.collections.Result.retry_left">[docs]</a>    <span class="k">def</span> <span class="nf">retry_left</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get how many retries are left.</span>

<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">retry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span></div>

<div class="viewcode-block" id="Result.save"><a class="viewcode-back" href="../../viper.html#viper.collections.Result.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save the result in DB.</span>

<span class="sd">        :rtype: viper.collections.Result</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">ViperDB</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                INSERT INTO results (</span>
<span class="sd">                    hash, trigger_time, task, host, args, command,</span>
<span class="sd">                    stdout, stderr, returncode, start, end, retry</span>
<span class="sd">                ) VALUES (</span>
<span class="sd">                    ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?</span>
<span class="sd">                )</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trigger_time</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span>
                    <span class="n">dumpjson</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">),</span>
                    <span class="n">dumpjson</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Result.runner"><a class="viewcode-back" href="../../viper.html#viper.collections.Result.runner">[docs]</a>    <span class="k">def</span> <span class="nf">runner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runner</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Recreate the runner from the result.</span>

<span class="sd">        :rtype: viper.collections.Runner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Runner</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Results"><a class="viewcode-back" href="../../viper.html#viper.collections.Results">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Results</span><span class="p">(</span><span class="n">Items</span><span class="p">[</span><span class="n">Result</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;A group of :py:class:`viper.collections.Results`.&quot;&quot;&quot;</span>

    <span class="n">_all</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Result</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">tuple</span><span class="p">)</span>
    <span class="n">_item_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Result</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Result</span><span class="p">)</span>

<div class="viewcode-block" id="Results.from_history"><a class="viewcode-back" href="../../viper.html#viper.collections.Results.from_history">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_history</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Results</span><span class="p">],</span> <span class="n">final</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Results</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch and return all the results from history.</span>

<span class="sd">        :rtype: ciper.collections.Results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ViperDB</span><span class="p">(</span><span class="n">ViperDB</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM results ORDER BY start DESC&quot;</span><span class="p">)</span>
            <span class="n">result_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_item_type</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="o">*</span><span class="n">result_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">final</span><span class="p">()</span> <span class="k">if</span> <span class="n">final</span> <span class="k">else</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Results.by_host"><a class="viewcode-back" href="../../viper.html#viper.collections.Results.by_host">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">by_host</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="n">Host</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Results</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch and return results from history of the given host.</span>

<span class="sd">        :param viper.collections.Host host: Fetch results of this host.</span>
<span class="sd">        :rtype: viper.collections.Results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ViperDB</span><span class="p">(</span><span class="n">ViperDB</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT id FROM results</span>
<span class="s2">                WHERE JSON_EXTRACT(host, &#39;$.ip&#39;) = ?</span>
<span class="s2">                ORDER BY start DESC</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">ip</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_item_type</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Results.by_task"><a class="viewcode-back" href="../../viper.html#viper.collections.Results.by_task">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">by_task</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Results</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch and return results from history of the given task.</span>

<span class="sd">        :param viper.collections.Host host: Fetch results of this task.</span>
<span class="sd">        :rtype: viper.collections.Results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ViperDB</span><span class="p">(</span><span class="n">ViperDB</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT id FROM results</span>
<span class="s2">                WHERE JSON_EXTRACT(task, &#39;$.name&#39;) = ?</span>
<span class="s2">                ORDER BY start DESC</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_item_type</span><span class="o">.</span><span class="n">by_id</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Results.hosts"><a class="viewcode-back" href="../../viper.html#viper.collections.Results.hosts">[docs]</a>    <span class="k">def</span> <span class="nf">hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Hosts</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the list of hosts from the results.</span>

<span class="sd">        :rtype: viper.collections.Hosts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Hosts</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">host</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">)</span></div>

<div class="viewcode-block" id="Results.final"><a class="viewcode-back" href="../../viper.html#viper.collections.Results.final">[docs]</a>    <span class="k">def</span> <span class="nf">final</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Results</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the final results only (ignoring the previous retries).</span>

<span class="sd">        :rtype: viper.collections.Results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">Host</span><span class="p">,</span> <span class="n">Result</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">trigger_time</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">trigger_time</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">result</span><span class="o">.</span><span class="n">host</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
                <span class="k">continue</span>

            <span class="n">res_grp</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">trigger_time</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">host</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_grp</span><span class="p">:</span>
                <span class="n">res_grp</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">res_grp</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">host</span><span class="p">]</span><span class="o">.</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="n">result</span><span class="o">.</span><span class="n">retry</span><span class="p">:</span>
                <span class="n">res_grp</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">res_grp</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">res_grp</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Results</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="o">*</span><span class="n">out</span><span class="p">)</span></div>

<div class="viewcode-block" id="Results.runners"><a class="viewcode-back" href="../../viper.html#viper.collections.Results.runners">[docs]</a>    <span class="k">def</span> <span class="nf">runners</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runners</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Recreate the runners from the results.</span>

<span class="sd">        :rtype: viper.collections.Runners</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Runners</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">runner</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all</span><span class="p">)</span></div>

<div class="viewcode-block" id="Results.re_run"><a class="viewcode-back" href="../../viper.html#viper.collections.Results.re_run">[docs]</a>    <span class="k">def</span> <span class="nf">re_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">max_workers</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Results</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Recreate the runners from the results and run again.</span>

<span class="sd">        :rtype: viper.collections.Results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runners</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span></div></div>
</pre></div>

          </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Viper Infrastructure Commander</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=sayanarijit&repo=viper&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api.html">The Viper Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">The Viper Command-line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending_cli.html">Extending the Command-line Interface (using <code class="docutils literal notranslate"><span class="pre">viperfile.py</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../footnotes.html">Further Readings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../footnotes.html#contributing-to-viper">Contributing To Viper</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Arijit Basu.

    </div>


    <a href="https://github.com/sayanarijit/viper" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>



  </body>
</html>
